name: üìä Daily Activity Logger

on:
  schedule:
    # Hourly activity logging (every hour at minute 0)
    - cron: '0 * * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  daily-activity-log:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up environment
        run: |
          # Install jq for JSON processing
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Make scripts executable
          chmod +x scripts/*.sh
      
      - name: Set up date variables
        run: |
          echo "LOG_DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "LOG_DATE_DISPLAY=$(date '+%B %d, %Y')" >> $GITHUB_ENV
      
      - name: Fetch WakaTime data
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          echo "üìä Fetching WakaTime data for $LOG_DATE"
          ./scripts/fetch-wakatime.sh "$LOG_DATE"
      
      - name: Fetch GitHub contributions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          echo "üêô Fetching GitHub contributions for $LOG_DATE"
          ./scripts/fetch-github.sh "$LOG_DATE"
      
      - name: Update activity logs
        run: |
          echo "üìù Updating activity logs for $LOG_DATE"
          ./scripts/update-log.sh "$LOG_DATE"
      
      - name: Set Git user identity
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        env:
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          PAT: ${{ secrets.PAT }}
        run: |
          # Use personal credentials if available, otherwise keep the default bot identity
          if [[ -n "${GIT_USER_EMAIL}" && -n "${GIT_USER_NAME}" ]]; then
            git config --local user.email "${GIT_USER_EMAIL}"
            git config --local user.name "${GIT_USER_NAME}"
            echo "üîß Using personal Git identity: ${GIT_USER_NAME} <${GIT_USER_EMAIL}>"
          else
            echo "ü§ñ Using default GitHub Actions bot identity"
          fi
          
          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            git add activity.log activity.json summaries/
            git commit -m "üìä Daily activity log: $LOG_DATE_DISPLAY"
            
            # Use PAT for push if available, otherwise use default GITHUB_TOKEN
            if [[ -n "${PAT}" ]]; then
              git push https://x-access-token:${PAT}@github.com/${{ github.repository }}.git HEAD:main
              echo "‚úÖ Activity log committed and pushed using PAT for $LOG_DATE_DISPLAY"
            else
              git push
              echo "‚úÖ Activity log committed and pushed using GITHUB_TOKEN for $LOG_DATE_DISPLAY"
            fi
          else
            echo "‚ÑπÔ∏è No changes to commit for $LOG_DATE_DISPLAY"
          fi