name: üìä Daily Activity Logger

on:
  schedule:
    # Daily activity logging at 11:59 PM UTC
    - cron: '59 23 * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  daily-activity-log:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up environment
        run: |
          # Install jq for JSON processing
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Make scripts executable
          chmod +x scripts/*.sh
      
      - name: Set up date variables
        run: |
          echo "LOG_DATE=$(date '+%Y-%m-%d')" >> $GITHUB_ENV
          echo "LOG_DATE_DISPLAY=$(date '+%B %d, %Y')" >> $GITHUB_ENV
      
      - name: Fetch WakaTime data
        env:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
        run: |
          echo "üìä Fetching WakaTime data for $LOG_DATE"
          ./scripts/fetch-wakatime.sh "$LOG_DATE"
      
      - name: Fetch GitHub contributions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        run: |
          echo "üêô Fetching GitHub contributions for $LOG_DATE"
          ./scripts/fetch-github.sh "$LOG_DATE"
      
      - name: Update activity logs
        run: |
          echo "üìù Updating activity logs for $LOG_DATE"
          ./scripts/update-log.sh "$LOG_DATE"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Check if there are changes to commit
          if [[ -n $(git status --porcelain) ]]; then
            git add activity.log activity.json summaries/
            git commit -m "üìä Daily activity log: $LOG_DATE_DISPLAY"
            git push
            echo "‚úÖ Activity log committed and pushed for $LOG_DATE_DISPLAY"
          else
            echo "‚ÑπÔ∏è No changes to commit for $LOG_DATE_DISPLAY"
          fi